\chapter{Technical design} \label{chap:tech_design}
% describe specific implementation details
\section{Quantum sensing setup}
\section{Photodetector design}\label{chap:td:tia_design}
As an integral part of the sensing setup, the photodetector needs a lot of attention. Good amplification is crucial to increasing the \gls{snr} of the quantum setup. Based on the design ideas presented in the functional design (see Chapter \ref{chap:photodetection_design}), the photodetection circuit can be drawn up.

\subsection{First iteration}
As previously mentioned, the first iteration of the PCB uses component values provided by the client. There is no specific information for the design process, aside from the fact that the original designer made the photodetector for input currents in the range of several nanoamperes. Such low inputs require high $R_1$ values, however increasing the resistor value results in more biasing current going to the amplifier and a more limited dynamic range \cite{black2021tia}. Furthermore, it is entirely possible that the original design did not thoroughly consider the bandwidth needed for different protocols, as \gls{cwodmr} setups do not require broad bandwidths \cite{acharya2025compact}. Biasing is another concern with this photodiode setup. The configuration shown in Figures \ref{fig:tia} and \ref{fig:td:tia_circuit_parasitic_v1} has the diode in the photovoltaic mode, which is suitable for low-frequency, low-light operation. In spite of this setup being suited to \gls{cwodmr}, pulsed protocols require micro to nanosecond precision




%\begin{equation}\label{eq:gbw}
%	f_{c} = (1 + \frac{C_d + C_{cm} + C_{df}}{C_1})f_{rc} \approx f_{rc}
%\end{equation}
%
%Even though $f_{rc}$ provides an approximation for the cutoff frequency, the parasitic capacitances in the system will cause it to be slightly bigger. Equation \ref{eq:gbw} shows how a more accurate cutoff frequency $f_c$ can be calculated by taking into account $C_d$ and $C_{cm}$ (differential and common-mode capacitance respectively). In this case, $f_c$ tells us the gain bandwidth or the frequency range in which DC gain is retained.

\subsection{Second iteration}
Building on the time-domain analysis in the previous chapters, a frequency-domain analysis can help fill in the gaps \cite{margan2012transimpedance, sackinger2017analysis, horsthemke2025all}. 

\begin{figure}[!ht]
	\centering
	\resizebox{.7\textwidth}{!}{%
		\begin{circuitikz}
			\tikzstyle{every node}=[font=\normalsize]
			\draw [ line width=0.5pt](1.5,10.75) to[empty photodiode,l={ \normalsize $D_1$}] (1.5,9);
			\draw [ line width=0.5pt](6.5,10.25) node[op amp,scale=1] (opamp2) {};
			\draw [ line width=0.5pt](opamp2.+) to[short] (5,9.75);
			\draw [ line width=0.5pt] (opamp2.-) to[short] (5,10.75);
			\draw [ line width=0.5pt](7.7,10.25) to[short](8,10.25);
			\draw [line width=0.5pt](5,9) to (5,8.25) node[ground]{};
			\draw [ line width=0.5pt](5,8.5) to[short] (5,9.75);
			\draw [ line width=0.5pt](1.5,10.5) to[short] (1.5,10.75);
			\draw [ line width=0.5pt](1.5,10.75) to[short] (2.75,10.75);
			\node at (4.5,10.75) [circ] {};
			\draw [ line width=0.5pt](4.5,10.75) to[short] (4.5,13.5);
			\draw [ line width=0.5pt](4.5,12.25) to[short] (5,12.25);
			\draw [ line width=0.5pt](4.5,13.5) to[short] (5,13.5);
			\draw [ line width=0.5pt](5,12.25) to[european resistor,l={ \normalsize $R_1$}] (7,12.25);
			\node at (4.5,12.25) [circ] {};
			\draw [ line width=0.5pt](7,12.25) to[short] (7.5,12.25);
			\draw [ line width=0.5pt](7.5,12.25) to[short] (7.5,11);
			\draw [ line width=0.5pt](7.5,12.25) to[short] (7.5,13.5);
			\draw [line width=0.5pt](5,13.5) to[C,l={ \normalsize $C_1$}] (7,13.5);
			\node at (7.5,12.25) [circ] {};
			\draw [ line width=0.5pt](7,13.5) to[short] (7.5,13.5);
			\draw [ line width=0.5pt](1.5,10.75) to[short] (1.5,10.5);
			\draw [line width=0.5pt](1.5,9) to (1.5,8.25) node[ground]{};
			\draw [line width=0.5pt, ->, >=Stealth] (1,10.25) -- (1,9.25);
			\node [font=\normalsize] at (0.6,9.75) {$-I_f$};
			\draw [ line width=0.5pt](6.5,10.25) node[op amp,scale=1] (opamp2) {};
			\draw [ line width=0.5pt](opamp2.+) to[short] (5,9.75);
			\draw [ line width=0.5pt] (opamp2.-) to[short] (5,10.75);
			\draw [ line width=0.5pt](7.7,10.25) to[short](8,10.25);
			\draw (8,10.25) to[short, -o] (8.25,10.25) node[] {$\ \ \ \ \ \ \ \ \ V_{out}$};
			\draw (7.5,11) to[short] (7.5,10.25);
			\draw [line width=1pt](5,9.75) to[C,l={ \normalsize $C_{df}$}] (5,10.75);
			\draw [line width=1pt](-0.25,9) to[C,l={ \normalsize $C_{d}$}](-0.25,10.5);
			\draw (0.25,10.5) to[short] (1.5,10.5);
			\draw (0.25,9) to[short] (1.5,9);
			\draw (3.75,10.75) to[short] (5,10.75);
			\draw [line width=1pt](3.75,8) to[C,l={ \normalsize $C_{cm}$}](3.75,10.75);
			\draw (3.75,8.5) to (3.75,8.25) node[ground]{};
			\draw [ line width=0.5pt](6.5,10.25) node[op amp,scale=1](opamp2) {};
			\draw [ line width=0.5pt](opamp2.+) to[short] (5,9.75);
			\draw [ line width=0.5pt] (opamp2.-) to[short] (5,10.75);
			\draw [ line width=0.5pt](7.7,10.25) to[short](8,10.25);
			\node at (3.75,10.75) [circ] {};
			\node at (5,10.75) [circ] {};
			\node at (5,9.75) [circ] {};
			\node at (1.5,9) [circ] {};
			\node at (1.5,10.5) [circ] {};
			\node at (7.5,10.25) [circ] {};
			\draw (-0.25,10.5) to[short] (0.25,10.5);
			\draw (-0.25,9) to[short] (0.25,9);
			\draw (2.75,10.75) to[short] (3.75,10.75);
		\end{circuitikz}
	}%
	\caption{Parasitic capacitances in a \gls{tia} circuit}
	\label{fig:td:tia_circuit_parasitic_v1}
\end{figure}

Introducing the real-world parasitic capacitances to the ideal \gls{tia} shown in Figure \ref{fig:tia} results in the circuit in Figure \ref{fig:td:tia_circuit_parasitic_v1}. The diode capacitance $C_d$, combined with the differential and common-mode capacitances of the amplifier ($C_{df}$ and $C_{cm}$), contributes a significant amount of capacitance to the circuit and can result in instability \cite{cherian2016you}.

\begin{equation}\label{eq:td:ci}
	C_i = C_{d} + C_{df} + C_{cm}
\end{equation}

The combined input capacitance (Equation \ref{eq:td:ci}) is needed when solving the equation arising from \gls{kcl} at the inverting input of the amplifier. $Z_1$ (Equation \ref{eq:td:z1}), or the combined impedance of $R_1$ and $C_1$, is another prerequisite for deriving the transimpedance $Z_t$ using \gls{kcl}. Additionally, the open-loop gain $A_{ol}$ is needed for the derivation of the transimpedance. Equation \ref{eq:td:aol} shows the open-loop gain, expressed with the \gls{dc} open-loop gain $A_o$ and the open-loop cutoff frequency $\omega_s$, which is equivalent to $\frac{v_{out}}{v_{in}}$.

\begin{equation}\label{eq:td:z1}
	Z_1(s) = \frac{1}{\frac{1}{R_1} + sC_1}
\end{equation}

\begin{equation}\label{eq:td:aol}
	A_{ol}(s) = A_o\frac{\omega_0}{s + \omega_0} = \frac{v_{out}}{v_{in}}
\end{equation}

Finally, the values in the \gls{kcl} equation (Equation \ref{eq:td:kcl}) can be substituted, from which $Z_t$ can be derived, as seen in Equation \ref{eq:td:zt}. 

\begin{equation}\label{eq:td:kcl}
	i_f = \frac{v_i}{\frac{1}{sC_i}} + \frac{v_{in} - v_{out}}{Z_1(s)}
\end{equation}

\begin{equation}\label{eq:td:zt}
	\begin{aligned}
	&Z_t(s) = \frac{v_{out}}{i_f}\\
	&= \frac{A_o\omega_oR_1}{s^2R_f(C_i + C_f) + s(1 + \omega_oR_1C_1(1 + A_o) + \omega_oR_1C_i) + \omega_o(1 + A_o)}\\
	&= A_{ol}(s)\frac{Z_f}{1 + A_{ol}(s) + sC_iZ_f}
	\end{aligned}
\end{equation}

Before moving on to the pole analysis, the impact of the quality factor $Q$ on the system response should be considered. Two system poles present when $Q > 0,5$. For $Q = \frac{\sqrt{3}}{3},$ the system has a Bessel response, which has the flattest group delay, however, if $Q = \frac{\sqrt{2}}{2}$, then the system has a Butterworth response, which means it has the flattest possible amplitude response. Although the group delay is not as important as the amplitude response, a Bessel response also results in smaller amount of overshoot and less jitter, which is why it is preferred. 

\begin{equation}\label{eq:td:poles_general}
	H(s) = H_0\frac{(-s_1)(-s_2)}{(s - s_1)(s - s_2)} = G_0\frac{s_1s_2}{s^2 + s(-s_1 - s_2) + s_1s_2}
\end{equation}


Based on this consideration, the poles can be found using the general form of a second order transfer function, shown in Equation \ref{eq:td:poles}.

\begin{equation}\label{eq:td:poles}
	\begin{aligned}
		&-s_1 - s_2 = \frac{1 + \omega_o(C_i + (1 + A_o)C_1)R_1}{(C_i + C_1)R_1} \\
		&s_1s_2 = \frac{\omega_o(1 + A_o)}{(C_i + C_1)R_1}
	\end{aligned}
\end{equation}

At this point in the design process, the values of $R_1$ and $C_1$ need to be considered again. 

\section{Photodetection implementation}
Implementing the photodetectors is as much about the creation of a physical board, as it is about simulating the circuits that are presented in Chapter \ref{chap:td:tia_design}. 


\subsection{First iteration}
Figure \ref{fig:photodetecog} shows the LTSpice design. $C_1$ and $R_2$, as well as the current source $I_1$ are used to simulate the behavior of a photodiode.

\begin{figure} [ht]
	\centering
	\includegraphics[width=0.7\linewidth]{img/photodetec_og}
	\caption{Provided photodetector design}
	\label{fig:photodetecog}
\end{figure}


\subsubsection{Simulation}
Tina-TI was used to simulate and visualize the DC gain and frequency response of the system, as seen in Figure \ref{fig:tina2probes}. The signals $V_{ot}$ and $V_{out}$ correspond to the output of the transimpedance and non-inverting amplification stage respectively. The AC plot (Figure \ref{fig:tinaac2probes}) shows the cutoff, at \num{10,77} \unit{\kilo \hertz}, and the gain inside the gain bandwidth, which is \num{160,82} \unit{\decibel}. The DC plot (Figure \ref{fig:tinadc2probes}) shows the voltage with respect to the current and demonstrates the linearity of the system in the range of \numrange{0}{46,31} \unit{\nano \ampere}. After $V_{out}$ reaches \num{5} \unit{V}, the output remains fixed, because it cannot exceed the voltage provided to the amplifier. 

\begin{figure}[ht]
	\centering
	\begin{subfigure}[1a]{.49\linewidth}
		\includegraphics[width=\linewidth]{img/tina_AC_2probes}
		\caption{Frequency response}
		\label{fig:tinaac2probes}
	\end{subfigure}
	\hfill
	\begin{subfigure}[1b]{.49\linewidth}
		\includegraphics[width=\linewidth]{img/tina_DC_2probes}
		\caption{DC gain}
		\label{fig:tinadc2probes}
	\end{subfigure}
	\caption{Simulation of the first iteration of the photodetector}
	\label{fig:tina2probes}
\end{figure}


\subsubsection{Implementation} 
Figure \ref{fig:photodetecogpcb} shows the back side of the PCB. It hosts all components, except for the photodiode, which sits unobstructed on the front side. Requirements for the physical dimensions were also set by the client. The PCB needs to fit the Thorlabs mount standard, since the rest of the setup also uses it. 

\begin{figure}[ht]
	\centering
	\includegraphics[width=0.7\linewidth]{img/photodetec_og_pcb}
	\caption{First iteration of the photodetection PCB}
	\label{fig:photodetecogpcb}
\end{figure}


\section{OLIA implementation}
